import sys
import pygame
from sys import exit
from pathlib import Path

pygame.init()

# --- Display setup (fixed logical size; portable) ---
LOGICAL_W, LOGICAL_H = 416, 624
screen = pygame.display.set_mode((LOGICAL_W, LOGICAL_H))
pygame.display.set_caption('Double Jump')
clock = pygame.time.Clock()
font = pygame.font.SysFont(None, 28)
title_font = pygame.font.SysFont(None, 40)

# --- Portable asset loading (no absolute paths) ---
BASE_DIR = Path(__file__).resolve().parent
CANDIDATE_DIRS = [BASE_DIR, BASE_DIR / "sprites"]

def find_asset(filename: str) -> Path:
    for d in CANDIDATE_DIRS:
        p = d / filename
        if p.exists():
            return p
    raise FileNotFoundError(f"Asset not found: {filename} (looked in {CANDIDATE_DIRS})")

def load_image(filename: str) -> pygame.Surface:
    path = find_asset(filename)
    try:
        return pygame.image.load(str(path)).convert_alpha()
    except pygame.error:
        # Fallback if no alpha
        return pygame.image.load(str(path)).convert()

# Keep your original names
cyber_board = load_image('Green_Cyber_checker_board.jpg')
cyber_board = pygame.transform.smoothscale(cyber_board, (LOGICAL_W, LOGICAL_H))

# Optional pucks (ready for later)
green_puck = load_image('green_puck.png')
red_puck   = load_image('Red_puck.png')

# --- Board layout constants (unchanged) ---
CELL_W, CELL_H = 38, 38
ORIGIN_X, ORIGIN_Y = 44, 134  # A8 at this top-left
COLUMNS = "ABCDEFGH"
ROWS = list(range(8, 0, -1))  # 8 down to 1 (A8 is top-left)

def create_board_squares():
    """
    Create a dict mapping 'A8'..'H1' -> (surface, rect),
    with A8 at (ORIGIN_X, ORIGIN_Y).
    """
    x_offset = 2
    y_offset = 5
    squares = {}
    for c_idx, file_ in enumerate(COLUMNS):  # 0..7
        x = (ORIGIN_X + c_idx * (CELL_W + x_offset))
        for r_idx, rank in enumerate(ROWS):  # 0..7 for 8..1
            y = ORIGIN_Y + r_idx * (CELL_H + y_offset)
            name = f"{file_}{rank}"
            color = 'Grey'
            surf = pygame.Surface((CELL_W, CELL_H))
            surf.fill(color)
            rect = surf.get_rect(topleft=(x, y))
            squares[name] = (surf, rect)
    return squares

def login_screen():
    """
    Simple username input on a white background.
    Also supports touch-only devices by offering a Continue button.
    """
    username = ""
    prompt = "Type your name:"
    box_rect = pygame.Rect(40, 300, 336, 36)
    # Continue button for devices without keyboard
    btn_rect = pygame.Rect(140, 360, 136, 36)
    btn_label = "Continue"

    while True:
        mouse_click = False
        touch_click = None  # (x, y) in pixels if tapped

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit(); exit()

            # Keyboard input
            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_RETURN and username.strip():
                    return username.strip()
                elif event.key == pygame.K_BACKSPACE:
                    username = username[:-1]
                else:
                    if event.unicode and event.unicode.isprintable():
                        username += event.unicode

            # Mouse click
            if event.type == pygame.MOUSEBUTTONDOWN:
                mouse_click = True
                mx, my = event.pos
                if btn_rect.collidepoint(mx, my):
                    # If no name typed, use default
                    return (username.strip() or "Player")

            # Touch tap (normalized coords on mobile via pygame-ce)
            if hasattr(pygame, "FINGERDOWN") and event.type == pygame.FINGERDOWN:
                # Convert normalized (0..1) to pixels
                tx = int(event.x * LOGICAL_W)
                ty = int(event.y * LOGICAL_H)
                touch_click = (tx, ty)
                if btn_rect.collidepoint(tx, ty):
                    return (username.strip() or "Player")

        # White background
        screen.fill((255, 255, 255))

        # Title
        title_surf = title_font.render("DOUBLE JUMP", True, (0, 0, 0))
        title_rect = title_surf.get_rect(center=(LOGICAL_W // 2, 180))
        screen.blit(title_surf, title_rect)

        # Prompt
        prompt_surf = font.render(prompt, True, (0, 0, 0))
        prompt_rect = prompt_surf.get_rect(center=(LOGICAL_W // 2, 260))
        screen.blit(prompt_surf, prompt_rect)

        # Input box
        pygame.draw.rect(screen, (230, 230, 230), box_rect)
        pygame.draw.rect(screen, (0, 0, 0), box_rect, 2)
        text_surf = font.render(username or "", True, (0, 0, 0))
        screen.blit(text_surf, (box_rect.x + 8, box_rect.y + 8))

        # Continue button (for touch-only)
        pygame.draw.rect(screen, (0, 0, 0), btn_rect, 2)
        btn_txt = font.render(btn_label, True, (0, 0, 0))
        btn_txt_rect = btn_txt.get_rect(center=btn_rect.center)
        screen.blit(btn_txt, btn_txt_rect)

        pygame.display.update()
        clock.tick(60)

squares = create_board_squares()
player_name = login_screen()

while True:
    mouse_click = False
    tap_pos = None  # from touch

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            pygame.quit(); exit()

        if event.type == pygame.MOUSEBUTTONDOWN:
            mouse_click = True
            tap_pos = event.pos

        # Touch support (pygame-ce on mobile)
        if hasattr(pygame, "FINGERDOWN") and event.type == pygame.FINGERDOWN:
            tap_pos = (int(event.x * LOGICAL_W), int(event.y * LOGICAL_H))
            mouse_click = True  # treat tap like a click

    # Draw background board
    screen.blit(cyber_board, (0, 0))

    # Draw all 64 squares
    for name, (surf, rect) in squares.items():
        screen.blit(surf, rect)

    # Display the player name at the top
    name_label = font.render(f"Player: {player_name}", True, (255, 255, 255))
    screen.blit(name_label, (14, 10))

    # Handle clicks/taps to print board coordinate
    if tap_pos:
        mx, my = tap_pos
        for name, (surf, rect) in squares.items():
            if rect.collidepoint(mx, my):
                print(f"Clicked: {name}")
                break

    pygame.display.update()
    clock.tick(60)
